# 🏠 TRON能量助手本地测试最少地址需求

## 📊 地址需求总览

### 🎯 最少需要 **2个TRON地址**

| 地址类型 | 数量 | 作用 | 资金要求 |
|---------|-----|------|---------|
| **供应商钱包** | 1个 | 提供Energy，执行委托交易 | **100+ TRX** ⚠️ |
| **接收地址** | 1个 | 接收委托的Energy | 0 TRX (可以是空地址) |

### 🔐 安全提醒
- ⚠️ **仅使用测试资金，不要超过100 TRX**
- 🗝️ **测试完成后立即更换所有私钥**
- 💡 **建议准备2个供应商钱包作为备用**

---

## 📋 完整测试步骤清单

### 阶段1: 环境准备 (5分钟)

#### 1.1 启动后端服务
```cmd
cd C:\Users\wt200\trx-bot\backend
start_services.bat
```

#### 1.2 验证服务状态
```powershell
# 检查API健康状态
Invoke-RestMethod -Uri "http://localhost:8001/health"
# 期望结果: status = "healthy"
```

### 阶段2: 钱包配置 (5分钟)

#### 2.1 添加供应商钱包
```powershell
# 添加供应商钱包（有TRX和Energy的钱包）
$body = @{
    private_key = "你的64位私钥字符串"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8001/api/supplier-wallets/add" -Method POST -Body $body -ContentType "application/json"
```

#### 2.2 验证钱包添加成功
```powershell
# 查看钱包池状态
$wallets = Invoke-RestMethod -Uri "http://localhost:8001/api/supplier-wallets/"
$wallets[0]
# 确认: trx_balance > 50, energy_available > 0, is_active = true
```

### 阶段3: 用户充值 (3分钟)

#### 3.1 模拟用户充值
```powershell
# 为测试用户充值（模拟）
$body = @{
    tx_hash = "1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
    amount = 20.0
    currency = "TRX"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8001/api/users/999888/deposit" -Method POST -Body $body -ContentType "application/json"
```

#### 3.2 验证用户余额
```powershell
# 检查用户余额
Invoke-RestMethod -Uri "http://localhost:8001/api/users/999888/balance"
# 期望结果: balance_trx = "20.000000"
```

### 阶段4: 订单测试 (10分钟)

#### 4.1 创建Energy租赁订单
```powershell
# 创建订单（关键步骤）
$body = @{
    user_id = 999888
    energy_amount = 32000
    duration = "1h"
    receive_address = "你的接收地址(TR开头42字符)"
} | ConvertTo-Json

$orderResponse = Invoke-RestMethod -Uri "http://localhost:8001/api/orders/" -Method POST -Body $body -ContentType "application/json"
$orderId = $orderResponse.id
Write-Host "订单ID: $orderId"
```

#### 4.2 监控订单处理过程
```powershell
# 持续监控订单状态（每5秒查询一次）
while($true) {
    $order = Invoke-RestMethod -Uri "http://localhost:8001/api/orders/$orderId"
    Write-Host "$(Get-Date -Format 'HH:mm:ss'): 状态=$($order.status)"
    
    if($order.status -eq "completed" -or $order.status -eq "failed") {
        Write-Host "订单处理完成，最终状态: $($order.status)"
        break
    }
    Start-Sleep 5
}
```

#### 4.3 验证交易结果
```powershell
# 检查最终结果
$finalOrder = Invoke-RestMethod -Uri "http://localhost:8001/api/orders/$orderId"
$userBalance = Invoke-RestMethod -Uri "http://localhost:8001/api/users/999888/balance"

Write-Host "订单状态: $($finalOrder.status)"
Write-Host "用户余额: $($userBalance.balance_trx)"
Write-Host "交易哈希: $($finalOrder.tx_hash)"
```

### 阶段5: Telegram Bot测试 (10分钟)

#### 5.1 启动Bot
```cmd
# 新的命令行窗口
cd C:\Users\wt200\trx-bot
python main.py
```

#### 5.2 端到端用户体验测试
1. **启动对话**: 在Telegram中发送 `/start`
2. **添加地址**: 添加你的接收地址
3. **余额查询**: 点击 "Address balance" 验证真实余额
4. **选择参数**: 选择 "32K Energy, 1h"
5. **确认下单**: 点击 "Buy" 按钮
6. **观察处理**: 查看订单状态变化

---

## 🎯 成功验收标准

### ✅ API层面验收
- [ ] 供应商钱包成功添加，余额正确显示
- [ ] 用户充值成功，余额更新正确
- [ ] 订单创建成功，返回订单ID
- [ ] 订单状态从 `pending` → `processing` → `completed`
- [ ] 用户余额正确扣减（约0.021 TRX）

### ✅ 区块链层面验收
- [ ] 真实的TRON交易被创建
- [ ] 交易成功上链并确认
- [ ] Energy成功委托到接收地址
- [ ] 供应商钱包余额相应减少

### ✅ 用户体验验收
- [ ] Telegram Bot正常响应
- [ ] 地址验证功能正常
- [ ] 费用计算准确
- [ ] 下单流程流畅
- [ ] 订单状态实时更新

---

## 🚨 常见问题处理

### 问题1: 供应商钱包余额不足
```powershell
# 检查钱包余额
$wallets = Invoke-RestMethod -Uri "http://localhost:8001/api/supplier-wallets/"
Write-Host "TRX余额: $($wallets[0].trx_balance)"
Write-Host "Energy余额: $($wallets[0].energy_available)"
```
**解决**: 确保供应商钱包有足够的TRX和Energy

### 问题2: 订单状态卡在pending
```powershell
# 手动触发订单处理
Invoke-RestMethod -Uri "http://localhost:8001/api/supplier-wallets/process-orders" -Method POST
```

### 问题3: Bot无法连接后端
```cmd
# 检查后端服务状态
powershell -Command "Invoke-RestMethod -Uri 'http://localhost:8001/health'"
```

---

## 💡 优化建议

### 增强测试覆盖
如果你想更全面的测试，可以准备：
- **3个供应商钱包** - 测试钱包选择算法
- **多个接收地址** - 测试不同用户场景
- **不同Energy数量** - 测试各种订单规模

### 监控脚本
创建一个PowerShell监控脚本：
```powershell
# monitor.ps1
while($true) {
    $health = Invoke-RestMethod -Uri "http://localhost:8001/health"
    $wallets = Invoke-RestMethod -Uri "http://localhost:8001/api/supplier-wallets/"
    
    Write-Host "$(Get-Date): API=$($health.status), Wallets=$($wallets.Count)"
    Start-Sleep 30
}
```

---

## ⏱️ 预计时间投入

| 阶段 | 时间 | 备注 |
|-----|------|------|
| 环境准备 | 5分钟 | 启动服务和验证 |
| 钱包配置 | 5分钟 | 添加和验证供应商钱包 |
| 用户充值 | 3分钟 | 模拟充值操作 |
| 订单测试 | 10分钟 | 创建订单和监控处理 |
| Bot测试 | 10分钟 | 端到端用户体验 |
| **总计** | **33分钟** | 不包括问题排查时间 |

---

🎯 **核心目标**: 用最少的资源（2个地址，100 TRX）验证完整的能量租赁业务流程！