# 闪租页后端开发计划

## 开发策略

采用**渐进式开发**策略：先完成闪租页的完整后端功能，让其从演示版本变成真正可运营的商业功能，然后以此为基础扩展其他功能模块。

---

## 阶段1：后端基础架构 (预计1周)

### 1.1 项目搭建
- [ ] 创建FastAPI项目结构
- [ ] 配置开发环境和依赖管理
- [ ] 设置PostgreSQL数据库连接
- [ ] 配置Redis缓存和会话管理

### 1.2 数据模型设计
- [ ] 用户表 (users) - 存储Telegram用户信息和余额
- [ ] 订单表 (orders) - 存储能量租赁订单信息
- [ ] 用户钱包表 (user_wallets) - 存储用户绑定的TRON地址
- [ ] 余额变动表 (balance_transactions) - 记录所有余额变动

### 1.3 核心API接口
- [ ] **订单管理API**
  - `POST /api/orders` - 创建新订单
  - `GET /api/orders/{order_id}` - 查询订单状态
  - `GET /api/orders?user_id={user_id}` - 用户订单列表
- [ ] **用户余额API**
  - `GET /api/users/{user_id}/balance` - 查询用户余额
  - `POST /api/users/{user_id}/deduct` - 扣减余额（下单时）
  - `POST /api/users/{user_id}/deposit` - 充值确认
- [ ] **钱包管理API**
  - `GET /api/users/{user_id}/wallets` - 用户钱包列表
  - `POST /api/users/{user_id}/wallets` - 添加钱包地址
  - `DELETE /api/users/{user_id}/wallets/{address}` - 删除钱包

### 1.4 Bot集成改造
- [ ] 修改 `models.py` - 将用户余额从Mock改为API调用
- [ ] 修改 `buy_energy.py` - 订单创建调用后端API
- [ ] 保持现有前端界面不变，只替换数据来源

---

## 阶段2：真实业务逻辑 (预计1-2周)

### 2.1 供应商钱包池
- [ ] 供应商钱包表 (supplier_wallets) - 存储供应商钱包信息
- [ ] 钱包私钥安全存储和管理
- [ ] 钱包余额和Energy库存实时监控
- [ ] 钱包选择算法（按可用Energy选择最优钱包）

### 2.2 TRON交易引擎
- [ ] Energy委托交易实现
  - 集成tronpy库进行私钥签名
  - 调用`delegateResource`合约方法
  - 交易广播和确认监控
- [ ] 交易状态跟踪
  - 监控交易上链状态
  - 处理交易失败和重试
  - 更新订单状态

### 2.3 用户充值系统
- [ ] 充值地址监控
  - 监控固定充值地址的入账交易
  - 支持TRX和USDT TRC20充值
  - 自动汇率转换和余额更新
- [ ] 充值确认流程
  - 交易确认后自动更新用户余额
  - 充值记录和余额变动日志
  - 充值异常处理

### 2.4 订单处理引擎
- [ ] 异步订单处理
  - 使用Celery处理订单队列
  - 订单超时处理和自动取消
  - 失败订单的自动退款
- [ ] 订单状态管理
  - pending → processing → completed流程
  - 订单失败时的错误记录和处理
  - 用户通知机制

---

## 阶段3：监控和完善 (预计1周)

### 3.1 基础监控系统
- [ ] 系统健康监控
  - API响应时间和错误率
  - 数据库连接状态
  - Redis缓存状态
- [ ] 业务监控
  - 订单处理成功率
  - 钱包余额预警
  - 日订单量统计

### 3.2 运营管理功能
- [ ] 简单的管理员接口
  - 订单列表查询和状态查看
  - 钱包池状态监控
  - 用户余额调整功能
- [ ] 配置管理
  - 动态价格策略配置
  - 系统参数调整
  - 钱包启用/禁用管理

### 3.3 错误处理和日志
- [ ] 完善的错误处理机制
- [ ] 详细的操作日志记录
- [ ] 异常情况的自动恢复

---

## 技术实现细节

### 数据库表结构 (核心表)
```sql
-- 用户表
CREATE TABLE users (
    id BIGINT PRIMARY KEY,  -- Telegram用户ID
    balance_trx DECIMAL(18,6) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 订单表
CREATE TABLE orders (
    id VARCHAR(36) PRIMARY KEY,  -- UUID
    user_id BIGINT REFERENCES users(id),
    receive_address VARCHAR(42) NOT NULL,
    energy_amount INTEGER NOT NULL,
    duration_hours INTEGER NOT NULL,
    cost_trx DECIMAL(18,6) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户钱包表
CREATE TABLE user_wallets (
    id SERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    wallet_address VARCHAR(42) NOT NULL,
    UNIQUE(user_id, wallet_address)
);
```

### Bot改造要点
```python
# 现有代码改造示例
# models.py 中的用户余额从Mock改为API调用
class UserSession:
    def get_balance(self):
        # 调用后端API获取真实余额
        response = requests.get(f"{BACKEND_API}/users/{self.user_id}/balance")
        return response.json()
    
    def create_order(self, energy, duration, address):
        # 调用后端API创建订单
        order_data = {
            "energy_amount": energy,
            "duration": duration, 
            "receive_address": address
        }
        response = requests.post(f"{BACKEND_API}/orders", json=order_data)
        return response.json()
```

---

## 开发优势分析

### 立即开始闪租后端的好处：
1. **快速MVP**：2-3周内就有可运营的产品
2. **边学边做**：在相对简单的功能上学习后端开发
3. **用户验证**：真实用户使用验证产品市场需求
4. **现金流**：尽早开始产生收入
5. **架构基础**：为后续功能扩展打好技术基础

### 相比等所有前端完成的优势：
1. **降低复杂度**：避免一次性开发过多功能
2. **快速反馈**：用户使用闪租功能的反馈指导产品改进
3. **技术风险控制**：分步验证技术方案的可行性
4. **资源聚焦**：集中精力做好一个核心功能

---

## 成功指标

### 阶段1完成标准：
- [ ] 后端API正常响应，Bot可以成功调用
- [ ] 数据库正常存储订单和用户数据
- [ ] 现有Bot前端功能保持不变

### 阶段2完成标准：
- [ ] 用户可以正常充值，余额实时更新
- [ ] 订单可以真实执行Energy委托交易
- [ ] 交易成功率达到90%以上

### 阶段3完成标准：
- [ ] 系统7x24小时稳定运行
- [ ] 有基础的监控和报警机制
- [ ] 具备处理日常运营问题的能力

---

## 风险和应对

### 主要风险：
1. **TRON网络不稳定**：准备多个API节点备用
2. **私钥安全**：使用硬件安全模块或多重签名
3. **资金安全**：设置每日交易限额，异常监控

### 应对策略：
1. **小规模测试**：先用少量资金测试所有流程
2. **逐步放量**：确认稳定后再增加钱包池规模
3. **完善监控**：确保任何异常都能及时发现和处理

这个计划让你可以在相对较短的时间内拥有一个真正可运营的能量租赁服务，同时为未来的功能扩展打好基础。