# 🔧 TRON能量助手故障排除指南

## 🎯 指南目的

这个故障排除指南旨在帮助用户快速诊断和解决TRON能量助手系统中的常见问题。按照严重程度分类，提供系统性的解决方案。

---

## ⚠️ 紧急问题 - 系统无法启动

### 问题1: 后端API连接被拒绝 (最常见)

**症状表现**:
```
HTTPConnectionPool(host='localhost', port=8002): Max retries exceeded
[WinError 10061] 由于目标计算机积极拒绝，无法连接
```

**根本原因**: 后端API服务未运行

**解决步骤**:
```bash
# 1. 检查服务状态
curl http://localhost:8002/health

# 2. 启动后端服务
cd backend
python main.py

# 3. 验证服务正常
# 应该看到: INFO: Uvicorn running on http://0.0.0.0:8002
```

**验证修复**: 访问 http://localhost:8002/health 应返回 `{"status":"healthy"}`

### 问题2: Bot Token配置错误

**症状表现**:
```
telegram.error.InvalidToken: Invalid token
telegram.error.Unauthorized: Unauthorized
```

**解决步骤**:
1. 检查 `config.py` 中的 `BOT_TOKEN` 配置
2. 确认Token格式: `数字:字母数字-字符串` (如: `123456789:ABCdefGhIJKlmNoPQRsTUVwxyZ`)
3. 验证Token来自 @BotFather
4. 确认网络可访问 api.telegram.org

### 问题3: Python依赖包问题

**症状表现**:
```
ModuleNotFoundError: No module named 'fastapi'
ImportError: cannot import name 'xxx'
```

**解决步骤**:
```bash
# 1. 使用虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows

# 2. 升级pip
python -m pip install --upgrade pip

# 3. 重新安装依赖
cd backend && pip install -r requirements.txt
cd .. && pip install -r requirements.txt
```

---

## 🔍 功能性问题

### 问题4: 余额查询显示Mock数据

**症状表现**: 余额显示 "20.000 TRX" 等Mock数据而非真实余额

**原因分析**: 后端API不可用，系统启用容错模式

**解决步骤**:
1. 确认后端服务正常运行
2. 检查数据库连接
3. 验证API端点响应:
   ```bash
   curl http://localhost:8002/api/users/123456/balance
   ```

### 问题5: TRON地址余额查询失败

**症状表现**: "Address balance" 按钮无响应或显示错误

**可能原因**:
- TRON API网络连接问题
- 地址格式无效
- API调用频率限制

**解决步骤**:
1. 验证地址格式（T开头34位或41开头42位）
2. 检查网络连接:
   ```bash
   ping apilist.tronscan.org
   curl https://apilist.tronscan.org/api/account?address=TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t
   ```
3. 如有API Key，配置环境变量以提高调用限制

### 问题6: 订单创建失败

**症状表现**: 点击"Buy"后显示错误或订单状态为failed

**正常情况**: 本地测试时没有真实供应商钱包，订单失败是**预期行为**

**异常情况排查**:
1. 检查用户余额是否充足
2. 验证接收地址格式
3. 确认后端API和数据库正常

---

## 🛠️ 环境配置问题

### 问题7: 端口8002被占用

**症状表现**:
```
OSError: [WinError 10048] 通常每个套接字地址只允许使用一次
```

**解决步骤**:
```bash
# Windows
netstat -ano | findstr :8002
taskkill /F /PID <进程ID>

# Linux/Mac
lsof -i :8002
kill -9 <进程ID>
```

### 问题8: 防火墙阻止连接

**症状表现**: 本地能访问但外部无法连接

**解决步骤** (生产环境):
```bash
# Ubuntu/Debian
sudo ufw allow 8002

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=8002/tcp
sudo firewall-cmd --reload

# Windows
# 在Windows防火墙中添加8002端口入站规则
```

### 问题9: 数据库文件权限问题

**症状表现**: 
```
sqlite3.OperationalError: database is locked
PermissionError: [Errno 13] Permission denied
```

**解决步骤**:
```bash
# 检查数据库文件权限
ls -la backend/trx_energy.db

# 修复权限 (Linux/Mac)
chmod 664 backend/trx_energy.db

# Windows: 右键文件 -> 属性 -> 安全 -> 添加完全控制权限
```

---

## 📊 性能问题诊断

### 问题10: 系统响应缓慢

**症状表现**: API响应时间 > 5秒，Bot交互延迟

**诊断步骤**:
```bash
# 检查系统资源
top                    # Linux/Mac
taskmgr               # Windows

# 测试API响应时间
time curl http://localhost:8002/health

# 检查数据库大小
ls -lh backend/trx_energy.db
```

**优化建议**:
1. 确保有足够内存 (推荐4GB+)
2. 使用SSD存储
3. 定期清理日志文件
4. 考虑使用Redis缓存

### 问题11: 内存泄漏

**症状表现**: 长时间运行后内存使用持续增长

**监控方法**:
```bash
# 监控Python进程内存使用
ps aux | grep python
top -p <进程ID>
```

**缓解措施**:
1. 定期重启服务
2. 检查是否有死循环或资源未释放
3. 使用进程管理器 (PM2, Supervisor)

---

## 🌐 网络相关问题

### 问题12: Telegram API连接失败

**症状表现**:
```
telegram.error.NetworkError: Connection pool is full
requests.exceptions.ConnectTimeout
```

**解决步骤**:
1. 检查网络连接: `ping api.telegram.org`
2. 验证DNS解析: `nslookup api.telegram.org`
3. 检查代理设置
4. 考虑使用代理或VPN

### 问题13: TRON网络API不稳定

**症状表现**: 间歇性查询失败，超时错误

**解决方案**: 系统已内置多重备用机制
1. TronScan API (主要)
2. 官方TRON API (备用)
3. Mock数据 (最终降级)

**监控建议**:
```bash
# 监控API响应时间
curl -w "@curl-format.txt" -o /dev/null -s https://apilist.tronscan.org/api/account
```

---

## 🔧 高级故障排除

### 系统诊断命令集

```bash
# 完整系统健康检查脚本
#!/bin/bash

echo "=== TRON Bot System Diagnosis ==="
echo "1. Backend Service Status:"
curl -s http://localhost:8002/health || echo "Backend not running"

echo -e "\n2. Database Status:"
ls -la backend/trx_energy.db 2>/dev/null || echo "Database not found"

echo -e "\n3. Port Status:"
netstat -tuln | grep 8002 || echo "Port 8002 not listening"

echo -e "\n4. Process Status:"
ps aux | grep -E "(python.*main.py|uvicorn)" | grep -v grep

echo -e "\n5. Disk Space:"
df -h .

echo -e "\n6. Memory Usage:"
free -m 2>/dev/null || echo "Memory info not available"

echo -e "\n7. Network Connectivity:"
ping -c 1 api.telegram.org >/dev/null 2>&1 && echo "Telegram API: OK" || echo "Telegram API: FAILED"
ping -c 1 apilist.tronscan.org >/dev/null 2>&1 && echo "TRON API: OK" || echo "TRON API: FAILED"
```

### 日志分析指南

**重要日志位置**:
- Bot日志: 终端输出
- 后端日志: 终端输出 (FastAPI)
- 系统日志: /var/log/ (Linux) 或 事件查看器 (Windows)

**关键错误模式**:
```bash
# 搜索错误日志
grep -i "error\|exception\|failed" logfile.txt

# 监控实时日志
tail -f logfile.txt | grep -i "error"
```

---

## 🆘 紧急恢复程序

### 完全重置系统

如果系统出现无法修复的问题：

```bash
# 1. 停止所有服务
# Ctrl+C 停止所有正在运行的Python进程

# 2. 备份重要数据
cp backend/trx_energy.db backend/trx_energy.db.backup
cp user_wallets.json user_wallets.json.backup

# 3. 重新安装依赖
rm -rf venv/  # 如果使用虚拟环境
python -m venv venv
source venv/bin/activate
pip install -r backend/requirements.txt
pip install -r requirements.txt

# 4. 重新启动服务
cd backend && python main.py &
cd .. && python main.py
```

### 数据恢复

```bash
# 恢复数据库
cp backend/trx_energy.db.backup backend/trx_energy.db

# 恢复用户钱包
cp user_wallets.json.backup user_wallets.json
```

---

## 📞 技术支持

### 自助诊断清单

在寻求帮助前，请完成以下检查：

- [ ] 确认Python版本 3.8+
- [ ] 确认所有依赖已安装
- [ ] 确认Bot Token配置正确
- [ ] 确认网络连接正常
- [ ] 确认端口8002未被占用
- [ ] 查看了相关日志输出
- [ ] 尝试了重启服务

### 问题报告模板

```
TRON能量助手问题报告

系统信息:
- 操作系统: ___________
- Python版本: ___________  
- 问题发生时间: ___________

问题描述:
[详细描述问题现象]

错误日志:
[粘贴完整的错误信息]

重现步骤:
1. ___________
2. ___________
3. ___________

已尝试的解决方案:
[列出已尝试的解决步骤]

期望结果:
[描述预期的正常行为]
```

---

## 🎯 预防措施

### 定期维护建议

1. **每日检查** (自动化):
   ```bash
   # 健康检查脚本
   curl -s http://localhost:8002/health
   ```

2. **每周维护**:
   - 检查日志文件大小
   - 备份数据库文件
   - 更新系统依赖

3. **每月维护**:
   - 检查磁盘空间
   - 更新Python包
   - 性能评估

### 监控设置

```bash
# 使用crontab设置定期健康检查
echo "*/5 * * * * curl -s http://localhost:8002/health || echo 'Backend down at $(date)' >> /var/log/trx-bot.log" | crontab -
```

这个故障排除指南覆盖了TRON能量助手系统的主要问题场景，按照严重程度和类别系统性地提供解决方案。大部分问题都可以通过这个指南快速解决。