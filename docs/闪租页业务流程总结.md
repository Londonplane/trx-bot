# 闪租页业务流程总结

## 概述

闪租页是TRON能量助手机器人的核心功能模块，提供快速能量租赁服务。用户可以选择能量数量、租用时长，并通过钱包地址接收能量。

## 主要业务流程

### 1. 页面入口
- 用户从主菜单点击 "⚡ Buy Energy（闪租）"
- 系统调用 `main.py:159` 中的 `handle_buy_energy_callback` 处理

### 2. 页面状态管理

#### 2.1 初始状态
- 默认时长：1h
- 默认能量：65K
- 地址状态：未选择
- 显示提示文案："Select the required number of days and energy..."

#### 2.2 完整状态
- 时长、能量、地址都已选择
- 显示实时成本计算
- 显示地址余额信息（如果已查询）

### 3. 参数选择流程

#### 3.1 时长选择 (`buy_energy.py:165-174`)
- 可选项：1h, 1d, 3d, 7d, 14d
- 选中状态用 🔸 高亮显示
- 实时更新成本计算

#### 3.2 能量数量选择 (`buy_energy.py:176-200`)
- 预设选项：65K, 135K, 270K, 540K, 1M
- 自定义选项：点击 "✏️ Other amount" 进入文本输入模式
- 选中状态用 🔹 高亮显示
- 自定义输入支持1,000-10,000,000范围

### 4. 地址管理流程

#### 4.1 地址选择 (`buy_energy.py:202-204`, `main.py:251-293`)
- 首次选择：显示"✅ Select address"按钮
- 已有地址：显示地址列表，支持选择切换
- 新增地址：支持添加新的TRON钱包地址
- 地址验证：自动验证Base58和Hex格式

#### 4.2 地址验证机制 (`models.py:107-118`)
```python
def is_valid_tron_address(address: str) -> bool:
    if address.startswith('T') and len(address) == 34:  # Base58格式
        return True
    elif len(address) == 42 and address.startswith('41'):  # Hex格式
        return True
    return False
```

### 5. 余额查询系统

#### 5.1 查询触发 (`buy_energy.py:206-208`)
- 点击 "🔄 Address balance" 按钮
- 显示临时提示消息："🔄 Updating balance…"
- 异步执行TRON API查询

#### 5.2 API集成架构 (`tron_api.py:167-177`)
- **主API**: TronScan API (`https://apilist.tronscan.org`)
- **备用API**: 官方TRON API (`https://api.trongrid.io`)
- **容错机制**: 主API失败时自动切换备用API

#### 5.3 余额数据结构 (`tron_api.py:7-20`)
```python
@dataclass
class AccountBalance:
    address: str
    trx_balance: float          # TRX余额
    energy_available: int       # 可用Energy
    bandwidth_available: int    # 可用Bandwidth
    # ... 其他字段
```

### 6. 成本计算系统 (`models.py:120-143`)

#### 6.1 定价公式
```python
base_price = energy_val * 0.00001      # 基础价格
time_multiplier = duration_val * 0.8    # 时间倍数
total_cost = base_price * time_multiplier
```

#### 6.2 支持的能量单位
- K单位：65K = 65,000 Energy
- M单位：1M = 1,000,000 Energy  
- 自定义：支持任意整数输入

### 7. 支付确认流程

#### 7.1 余额检查 (`buy_energy.py:351-366`)
- 检查用户TRX余额是否充足
- 余额不足：显示充值页面和倒计时
- 余额充足：执行模拟支付流程

#### 7.2 支付成功处理 (`buy_energy.py:368-430`)
- 扣减用户余额（模拟）
- 生成订单ID和交易哈希
- 显示成功消息和TronScan链接
- 提供"Buy more"和"Check balance"操作

### 8. 充值系统 (`buy_energy.py:452-540`)

#### 8.1 充值页面
- 显示指定的充值地址
- 支持TRX和USDT TRC20
- 汇率说明：1 TRX = 0.38826 USDT
- 最低充值限制：10 TRX / 10 USDT

#### 8.2 倒计时功能
- 3分钟（180秒）自动倒计时
- 每5秒更新一次显示
- 倒计时结束自动删除消息

### 9. 界面交互设计

#### 9.1 按钮布局
```
行1: [1h] [1d] [3d] [7d] [14d]           # 时长选择
行2: [65K] [135K] [270K] [540K] [1M]     # 能量选择
行3: [✏️ Other amount]                    # 自定义输入
行4: [✅ BUY] / [✅ Select address]      # 主要操作
行5: [Change address] [Address balance]  # 地址操作  
行6: [❌ Later]                          # 退出操作
```

#### 9.2 消息格式
```
Calculation of the cost of purchasing energy:

🎯 Address: TQ5kjKLLm9X4L2D1JgogNis6V1YoAm6sv2
ℹ️ Address balance:
TRX: 18.900009
ENERGY: 0
BANDWIDTH: 395

⚡️ Amount: 65 000
📆 Period: 1h 
💵 Cost: 5.85 TRX 

Assemble your order with buttons...
```

### 10. 错误处理机制

#### 10.1 网络异常
- API请求超时（10秒）
- 网络连接失败
- 自动降级到备用API

#### 10.2 地址异常  
- 地址格式验证失败
- 地址未激活（需接收0.1 TRX激活）
- 提供详细错误提示

#### 10.3 余额异常
- 余额不足时显示充值选项
- 无法查询余额时保持现有状态

### 11. 数据持久化

#### 11.1 会话数据（内存）
- 用户选择状态（时长、能量、地址）
- 余额缓存信息
- 订单历史记录

#### 11.2 钱包数据（文件）
- 存储位置：`user_wallets.json`
- 结构：`{user_id: [address1, address2, ...]}`
- 实时同步：添加/删除地址时立即保存

### 12. 安全特性

#### 12.1 数据安全
- 只执行查询操作，不涉及私钥
- 不存储敏感信息，仅缓存余额
- 地址格式严格验证

#### 12.2 API安全
- 请求超时限制
- 错误信息隔离
- 异常捕获和日志记录

## 技术架构

### 核心文件职责
- `main.py`: 消息路由和回调处理
- `buy_energy.py`: 闪租页面逻辑和UI生成
- `models.py`: 数据模型和会话管理
- `tron_api.py`: TRON区块链API集成

### 状态流转
1. 初始化 → 参数选择 → 地址管理 → 余额查询 → 支付确认 → 完成/失败

### API集成
- TronScan API (主)：更稳定，响应快速
- TRON官方API (备)：官方接口，功能完整
- 双API容错：确保服务可用性

## 用户体验亮点

1. **无缝交互**: 所有操作通过消息编辑完成，保持上下文
2. **实时反馈**: 参数选择和余额查询即时响应
3. **智能提示**: 根据状态显示不同的操作按钮
4. **错误友好**: 详细的错误提示和恢复建议
5. **数据持久**: 钱包地址自动保存，无需重复添加